# Advanced CoreDNS Configuration
# Multi-zone setup with security and monitoring

# Local zone for internal network
internal.local:53 {
    # Serve from zone file
    file /etc/coredns/zones/internal.local.db {
        reload 1m  # Reload zone file every minute
    }
    
    # Log queries for this zone
    log {
        class all
    }
    
    # Log errors
    errors
}

# Public zone for example.com
example.com:53 {
    # Serve from zone file
    file /etc/coredns/zones/example.com.db {
        reload 1m
    }
    
    # Enable DNSSEC
    dnssec {
        key file /etc/coredns/keys/Kexample.com.+013+12345.key
    }
    
    # Log queries
    log {
        class all
    }
    
    # Log errors
    errors
}

# Default zone - forward to upstream servers
.:53 {
    # Forward to multiple upstream servers with health checks
    forward . 8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1 {
        health_check 5s
        except internal.local example.com  # Don't forward these zones
    }
    
    # Cache responses
    cache {
        success 9984 30
        denial 9984 5
    }
    
    # Rate limiting
    rate_limit {
        window 1m
        max_requests 100
    }
    
    # Access control
    acl {
        block 192.168.1.0/24    # Block this subnet
        allow 10.0.0.0/8        # Allow this subnet
    }
    
    # Prometheus metrics on port 9153
    prometheus :9153
    
    # Health check endpoint on port 8080
    health :8080
    
    # Log all queries
    log {
        class all
        format json
    }
    
    # Log errors with consolidation
    errors {
        consolidate 5m
    }
}
