# Secure CoreDNS Configuration
# DNS over TLS and HTTPS with security features

# DNS over TLS upstream
.:53 {
    # Forward to DNS over TLS servers
    forward . tls://8.8.8.8 tls://8.8.4.4 {
        tls_servername dns.google
        health_check 5s
    }
    
    # Cache responses
    cache {
        success 9984 30
        denial 9984 5
    }
    
    # Rate limiting to prevent abuse
    rate_limit {
        window 1m
        max_requests 50
    }
    
    # Access control - only allow specific networks
    acl {
        allow 10.0.0.0/8
        allow 172.16.0.0/12
        allow 192.168.0.0/16
        block 0.0.0.0/0
    }
    
    # DNS over HTTPS support
    https://dns.google/dns-query {
        tls_servername dns.google
    }
    
    # Prometheus metrics
    prometheus :9153
    
    # Health check
    health :8080
    
    # Logging
    log {
        class all
        format json
    }
    
    # Error logging
    errors {
        consolidate 5m
    }
}
